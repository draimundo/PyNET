import scipy

import cv2 as cv
import numpy as np


# Python version of Naturalness Image Quality Evaluator (NIQE)
# Original MATLAB source code: https://github.com/dsoellinger/blind_image_quality_toolbox/tree/master/%2Bniqe
# Original Python version at: https://github.com/idearibosome/srzoo/blob/master/evaluators/niqe.py

def create_evaluator():
  return NIQEEvaluator()


class NIQEEvaluator:

  def __init__(self):
    super().__init__()

    self._init_model_params()

    self.config = {
      'blocksizerow': 96,
      'blocksizecol': 96,
      'featnum': 18,
      'scalenum': 2
    }


  def evaluate(self, output_images, truth_images):
    # NIQE is a no-reference metric: it only depends on output_image
    if (len(output_images.shape) == 4):
        batch_size = output_images.shape[0]
        avg_niqe = 0.0
        for i in range(batch_size): # process image by image
            avg_niqe += self._compute_quality(output_images[i, ...]) / batch_size
        return avg_niqe
    else:
        print("Error NIQE input doesn't have 4 dimensions [batch; L; H; Colors]")
  

  def _compute_quality(self, image):
    
    if (len(image.shape) == 3):
      if (image.shape[2] == 3):
        image = cv.cvtColor(image.astype('float32'), cv.COLOR_RGB2GRAY)
      #image = image[:, :, 0]
    
    image = np.float64(image)
    row = image.shape[0]
    col = image.shape[1]

    block_rownum = int(np.floor(row / self.config['blocksizerow']))
    block_colnum = int(np.floor(col / self.config['blocksizecol']))
    image = image[0:(block_rownum * self.config['blocksizerow']), 0:(block_colnum * self.config['blocksizecol'])]

    window = self._gaussian_filter_2d(shape=(7, 7), sigma=(7.0/6.0))
    window = window / np.sum(window)

    feat = []

    for itr_scale in range(1, self.config['scalenum']+1):
      mu = scipy.ndimage.filters.correlate(image, window, mode='nearest')
      mu_sq = mu * mu
      sigma = np.sqrt(np.abs(scipy.ndimage.filters.correlate(image * image, window, mode='nearest') - mu_sq))
      structdis = (image - mu) / (sigma + 1)

      feat_scale = []

      itr_blocksizerow = int(self.config['blocksizerow'] / itr_scale)
      itr_blocksizecol = int(self.config['blocksizecol'] / itr_scale)
      itr_block_rownum = block_rownum
      itr_block_colnum = block_colnum

      for row_index in range(itr_block_rownum):
        for col_index in range(itr_block_colnum):
          row_start = int(row_index * itr_blocksizerow)
          row_end = row_start + itr_blocksizerow
          col_start = int(col_index * itr_blocksizecol)
          col_end = col_start + itr_blocksizecol

          structdis_block = structdis[row_start:row_end, col_start:col_end]
          feat_block = self._compute_feature(structdis_block)
          feat_scale.append(feat_block)
      
      feat.append(feat_scale)

      image = cv.resize(image, None, fx=0.5, fy=0.5)
    
    feat = np.array(feat) # [scalenum, num_blocks, featnum]
    feat = feat.transpose([1, 0, 2]) # [num_blocks, scalenum, featnum]
    feat = feat.reshape([feat.shape[0], feat.shape[1] * feat.shape[2]]) # [num_blocks, scalenum*featnum]

    distparam = feat
    mu_distparam = np.nanmean(distparam, axis=0, keepdims=True)
    cov_distparam = np.cov(distparam.transpose())

    pinv_matrix = (self.model_param_cov + cov_distparam) / 2.0
    invcov_param = np.linalg.pinv(pinv_matrix, rcond=1e-4)
    quality = np.sqrt(np.matmul(np.matmul((self.model_param_mu - mu_distparam), invcov_param), (self.model_param_mu - mu_distparam).transpose()))
    quality = quality.flatten()[0]

    return quality
  
  
  def _compute_feature(self, structdis):
    gamma = scipy.special.gamma

    feat = []

    alpha, betal, betar = self._estimate_aggd_param(structdis.flatten())
    feat.extend([alpha, ((betal + betar) / 2.0)])

    shifts = [[0, 1], [1, 0], [1, 1], [1, -1]]
    for shift in shifts:
      shifted_structdis = np.roll(structdis, shift=shift, axis=[0, 1])
      pair = structdis.flatten() * shifted_structdis.flatten()
      alpha, betal, betar = self._estimate_aggd_param(pair)
      meanparam = (betar - betal) * (gamma(2.0 / alpha) / gamma(1.0 / alpha))

      feat.extend([alpha, meanparam, betal, betar])
    
    return feat
  

  def _estimate_aggd_param(self, vec):
    gamma = scipy.special.gamma

    gam = np.arange(start=0.2, stop=10.001, step=0.001)
    r_gam = ((gamma(2.0 / gam) ** 2) / (gamma(1.0 / gam) * gamma(3.0 / gam)))

    leftstd = np.sqrt(np.mean((vec[vec < 0]) ** 2))
    rightstd = np.sqrt(np.mean((vec[vec > 0]) ** 2))

    if (np.isnan(leftstd)):
      leftstd = 1e-8
    if (np.isnan(rightstd)):
      rightstd = 1e-8

    gammahat = leftstd / rightstd
    rhat = (np.mean(np.abs(vec)) ** 2) / (np.mean(vec ** 2))
    rhatnorm = (rhat * ((gammahat ** 3) + 1) * (gammahat + 1)) / (((gammahat ** 2) + 1) ** 2)

    array_position = np.argmin((r_gam - rhatnorm) ** 2)
    alpha = gam[array_position]

    betal = leftstd * np.sqrt(gamma(1.0 / alpha) / gamma(3.0 / alpha))
    betar = rightstd * np.sqrt(gamma(1.0 / alpha) / gamma(3.0 / alpha))

    return alpha, betal, betar


  def _gaussian_filter_2d(self, shape=(5, 5), sigma=1.0):
    m = (shape[0] - 1.0) / 2.0
    n = (shape[1] - 1.0) / 2.0
    y, x = np.ogrid[-m:(m+1), -n:(n+1)]

    h = np.exp(-((x ** 2) + (y ** 2)) / (2.0 * (sigma ** 2)))
    h[h < (np.finfo(h.dtype).eps * np.max(h))] = 0

    h_sum = np.sum(h)
    if (h_sum != 0):
      h = h / h_sum
    
    return h
  

  def _init_model_params(self):

    self.model_param_cov = np.array(
      [[0.435092657549114,0.135645465675407,0.0923375097194026,0.0230330000511282,0.0373043840937565,0.0654331431227482,0.0974823938603678,0.00198364462295988,0.0509426281554413,0.0553317682011440,0.0936659674591862,-0.00960808750699274,0.0586239126812414,0.0479272859677539,0.0926671818125777,-0.00865556222064107,0.0588111108555021,0.0466547385211699,0.361402807425791,0.121942053882977,0.0726252079406170,0.0132432731828132,0.0375451441228438,0.0539623846549658,0.0759210538720586,-0.00168176225260825,0.0462705527006805,0.0479657386899535,0.0747080297816002,-0.0120864546929862,0.0532241023116455,0.0408897173770164,0.0729369866361307,-0.00907715813403609,0.0517239848799406,0.0414807161067009],
      [0.135645465675407,0.0635673232327639,0.0331334117076063,0.00784391224502734,0.0172450103026786,0.0258040499780746,0.0341299462321665,0.00213783071095798,0.0206033328580932,0.0233462280511980,0.0318032973154749,-0.00467867138713052,0.0241442078892626,0.0197436422413693,0.0314006571715987,-0.00452845287285559,0.0241284335324324,0.0194199975202388,0.116818888403877,0.0578355736858628,0.0266953307167881,0.00463468005418670,0.0167055287705195,0.0221551353330602,0.0274048900105438,2.16834568771378e-05,0.0192934014286293,0.0203401107297310,0.0266613224318663,-0.00528119241684200,0.0222149975886107,0.0174623752191667,0.0260834771051091,-0.00471014929117413,0.0218717922886512,0.0174595448529864],
      [0.0923375097194026,0.0331334117076063,0.0221675503912366,0.00518893199207891,0.00925184818585392,0.0153972776294420,0.0228275534802133,0.00112839607453786,0.0117860331864655,0.0133752463851594,0.0215616788735925,-0.00197035815235394,0.0136106224242660,0.0113916026353827,0.0213419734312984,-0.00195594008614503,0.0136815082982389,0.0111024412113265,0.0784727357215461,0.0299067470512735,0.0178323960594352,0.00293092407757629,0.00919524357216057,0.0129361579634948,0.0184744657581586,-3.46100955952486e-05,0.0109478415060514,0.0116929362269536,0.0176897384727812,-0.00254132333324172,0.0124431067552065,0.00991448072240937,0.0173012652575821,-0.00223540348847444,0.0122693078508606,0.00988251226136343],
      [0.0230330000511282,0.00784391224502734,0.00518893199207891,0.00400180628332356,0.000947624251790564,0.00448468763882172,0.00633087907819108,-0.000709007884358141,0.00340390813170328,0.00286070806395175,0.00561848840367451,-0.000224682883410581,0.00328380093205985,0.00276340775713302,0.00562544004670873,-0.000245333496788975,0.00330893931475404,0.00270823830207435,0.0218209857384425,0.00901918420379835,0.00454661540205569,0.00294427980143546,0.00171684592633353,0.00439251710859732,0.00570037912630097,-0.00112287698477667,0.00386704520773219,0.00312048941253975,0.00532344900162504,-0.000905374766552308,0.00385460560865898,0.00294724485762602,0.00525297208055378,-0.000842227933470435,0.00382105455678612,0.00294888979222836],
      [0.0373043840937565,0.0172450103026786,0.00925184818585392,0.000947624251790564,0.00591311497590895,0.00751072471116163,0.00908737389747730,0.000764498156583093,0.00615695245740007,0.00718812966783831,0.00841107267117503,-0.00156262663558072,0.00734119487819242,0.00588639639817865,0.00827031454139494,-0.00163199102180054,0.00737313529014702,0.00573784141382834,0.0277035670479357,0.0144632316836233,0.00685774063010008,0.000114948712441739,0.00516505204383088,0.00577748962857037,0.00658181794202052,0.000265334222171931,0.00512112096351065,0.00567950746078331,0.00630356989194549,-0.00136638764138184,0.00597243460649076,0.00472554993839658,0.00614020954719486,-0.00131386354642790,0.00591832758372649,0.00469132332684277],
      [0.0654331431227482,0.0258040499780746,0.0153972776294420,0.00448468763882172,0.00751072471116163,0.0127821339625637,0.0162021790281179,-4.16851451545092e-05,0.0102635343170952,0.0106774361533936,0.0148380962890679,-0.00212611820430175,0.0114182893089534,0.00919125335220717,0.0146929079510625,-0.00225708157092228,0.0115238462794464,0.00891870713245928,0.0513390247834878,0.0231581775544190,0.0117787214251595,0.00250366724295251,0.00728940678790398,0.0103525973189758,0.0123892462748729,-0.000821793554494265,0.00919576819728390,0.00900542429366981,0.0117315465873236,-0.00240918493186005,0.0101023822331403,0.00778392150915872,0.0114576845110280,-0.00223556480132108,0.00998084022478105,0.00776656761619933],
      [0.0974823938603678,0.0341299462321665,0.0228275534802133,0.00633087907819108,0.00908737389747730,0.0162021790281179,0.0246875319601999,0.000366677288622318,0.0127438510840702,0.0137774858168579,0.0228497845624499,-0.00210750661331993,0.0142294632931641,0.0118171541492744,0.0226567821997862,-0.00211364895537243,0.0143321521731633,0.0114960158893637,0.0826839345938232,0.0309078501014965,0.0183954461094622,0.00410334491950447,0.00897291777521326,0.0136767892745572,0.0198944754406513,-0.000939453192095691,0.0118595421358191,0.0119193371526528,0.0187976863616255,-0.00277191272603916,0.0130275851357665,0.0102382760216327,0.0184394011568433,-0.00238550367381652,0.0128113385889265,0.0102700022745652],
      [0.00198364462295988,0.00213783071095798,0.00112839607453786,-0.000709007884358141,0.000764498156583093,-4.16851451545092e-05,0.000366677288622318,0.00273789099177482,-0.00102364795167075,0.00116890140443667,0.000670374325154823,0.000785000846512522,-5.01215666760419e-05,0.000575567045224017,0.000627446770230746,0.000905949543495518,-0.000157084077828913,0.000670753007105084,0.00668477789081098,0.00428455468500049,0.00176646069189922,-0.000728463678442498,0.00165450984895628,0.00109277373541330,0.00106690458705607,0.00196761671282399,0.000251193564540092,0.00193509781431234,0.00141610564321802,0.000106607474431605,0.00119885668109772,0.00133810474703704,0.00132165094762931,6.59972429751803e-05,0.00120950044432789,0.00126775103607386],
      [0.0509426281554413,0.0206033328580932,0.0117860331864655,0.00340390813170328,0.00615695245740007,0.0102635343170952,0.0127438510840702,-0.00102364795167075,0.00885216920387156,0.00834421583366857,0.0114104573394995,-0.00217390821798822,0.00942665337017425,0.00726311335352383,0.0113005742282759,-0.00239156408024843,0.00957700994727929,0.00697931035517952,0.0374890553530229,0.0172066739522044,0.00861171591368448,0.00192695552452475,0.00536513555384836,0.00770905832875434,0.00919936066811382,-0.00129563586338004,0.00720238203844992,0.00645971467081622,0.00859964466800269,-0.00197099318043390,0.00759611484870242,0.00569433226857054,0.00842816681645829,-0.00183641710204705,0.00749299199434515,0.00571783358044195],
      [0.0553317682011440,0.0233462280511980,0.0133752463851594,0.00286070806395175,0.00718812966783831,0.0106774361533936,0.0137774858168579,0.00116890140443667,0.00834421583366857,0.00985860505057839,0.0127065631200124,-0.00165373428820006,0.00984688652452871,0.00816727914514712,0.0125271665697139,-0.00166225873427248,0.00985655331864382,0.00799470742335227,0.0451980881436472,0.0212538615950055,0.0105264255857548,0.00140628874289993,0.00704298550389826,0.00899988422107916,0.0106845685577485,0.000173410993647610,0.00778812084172223,0.00845451266813383,0.0102138924023984,-0.00198137317297390,0.00896114012294850,0.00710054658643097,0.00995060868195415,-0.00183897000205496,0.00885627059513172,0.00706046268236221],
      [0.0936659674591862,0.0318032973154749,0.0215616788735925,0.00561848840367451,0.00841107267117503,0.0148380962890679,0.0228497845624499,0.000670374325154823,0.0114104573394995,0.0127065631200124,0.0228763436821264,-0.00221465520801526,0.0134740064904904,0.0111315176269839,0.0224062775550930,-0.00184487364897974,0.0133774493211763,0.0108890807145011,0.0807409160936473,0.0286736845060828,0.0177297797486554,0.00350915290343489,0.00847636965700833,0.0126755924068984,0.0188120359774508,-0.000580076973101854,0.0108174438360165,0.0111471647302227,0.0186097373386172,-0.00294714693353854,0.0124355438578247,0.00954939593194851,0.0181084795248346,-0.00212687695462374,0.0120262085667978,0.00966914016962025],
      [-0.00960808750699274,-0.00467867138713052,-0.00197035815235394,-0.000224682883410581,-0.00156262663558072,-0.00212611820430175,-0.00210750661331993,0.000785000846512522,-0.00217390821798822,-0.00165373428820006,-0.00221465520801526,0.00197007955023523,-0.00271323756411622,-0.00119836460645141,-0.00193580641835933,0.000581125728748911,-0.00212753270930174,-0.00158336206495600,-0.00322053789458281,-0.00225474105520967,-0.000873089493719083,2.97708504610328e-05,-0.000819541465372112,-0.000947665925679649,-0.000846043501064046,0.000700077013744395,-0.00121192024490309,-0.000621396109567943,-0.00101865919471896,0.00131307285826154,-0.00147963097452240,-0.000414373900657289,-0.000774153146598780,-7.79017159304869e-05,-0.000845108929299782,-0.000874530489202974],
      [0.0586239126812414,0.0241442078892626,0.0136106224242660,0.00328380093205985,0.00734119487819242,0.0114182893089534,0.0142294632931641,-5.01215666760419e-05,0.00942665337017425,0.00984688652452871,0.0134740064904904,-0.00271323756411622,0.0109188419347958,0.00831784056732931,0.0131483235347709,-0.00219536519961960,0.0106887804070163,0.00827356617149219,0.0442808219919840,0.0206844395888960,0.0102305417623996,0.00168540960786820,0.00668414351500589,0.00893113633450487,0.0105302072365606,-0.000697759068988541,0.00807048221524429,0.00790482147932248,0.0102656922343550,-0.00259078051898609,0.00914561510206579,0.00672991917723944,0.00992371571543941,-0.00181552583084278,0.00873102716011375,0.00694292265208757],
      [0.0479272859677539,0.0197436422413693,0.0113916026353827,0.00276340775713302,0.00588639639817865,0.00919125335220717,0.0118171541492744,0.000575567045224017,0.00726311335352383,0.00816727914514712,0.0111315176269839,-0.00119836460645141,0.00831784056732931,0.00708109076305884,0.0110231862051548,-0.00169140912015671,0.00856968526433224,0.00672243775550660,0.0393580481743461,0.0179712381378247,0.00897428006738813,0.00149380816403434,0.00579795727920235,0.00772700004072741,0.00925345736294322,-0.000121039217276250,0.00672502977608394,0.00706393694365084,0.00887834250940078,-0.00155874554632382,0.00757597694983924,0.00608804849915296,0.00870676284431552,-0.00180003620557692,0.00766324161055894,0.00591171011955172],
      [0.0926671818125777,0.0314006571715987,0.0213419734312984,0.00562544004670873,0.00827031454139494,0.0146929079510625,0.0226567821997862,0.000627446770230746,0.0113005742282759,0.0125271665697139,0.0224062775550930,-0.00193580641835933,0.0131483235347709,0.0110231862051548,0.0225933586035311,-0.00213940786634025,0.0134714119774838,0.0107521233917508,0.0796753413579246,0.0283039579306614,0.0175216359292110,0.00353209814712372,0.00831390650575915,0.0125051355991965,0.0186436346757814,-0.000580715998409644,0.0106482688217853,0.0109875746202778,0.0183016515248379,-0.00255324724006753,0.0120768558584028,0.00950167279225343,0.0181475427354119,-0.00249259712743066,0.0120745504433146,0.00943777158141186],
      [-0.00865556222064107,-0.00452845287285559,-0.00195594008614503,-0.000245333496788975,-0.00163199102180054,-0.00225708157092228,-0.00211364895537243,0.000905949543495518,-0.00239156408024843,-0.00166225873427248,-0.00184487364897974,0.000581125728748911,-0.00219536519961960,-0.00169140912015671,-0.00213940786634025,0.00220763431927234,-0.00298063703477121,-0.00111494614521109,-0.00236076754068524,-0.00201257407783952,-0.000654230538749693,0.000209676021122852,-0.000821656973696434,-0.000767041708788050,-0.000616266517198215,0.000649811640376943,-0.00106113962710213,-0.000555245793592938,-0.000639446810823043,6.08420416248514e-05,-0.000835778348634403,-0.000727757040717858,-0.000922771592208468,0.00130855868507192,-0.00141367287071130,-0.000365118061270627],
      [0.0588111108555021,0.0241284335324324,0.0136815082982389,0.00330893931475404,0.00737313529014702,0.0115238462794464,0.0143321521731633,-0.000157084077828913,0.00957700994727929,0.00985655331864382,0.0133774493211763,-0.00212753270930174,0.0106887804070163,0.00856968526433224,0.0134714119774838,-0.00298063703477121,0.0111951362149078,0.00808722231775449,0.0439747853659302,0.0204844118531375,0.0101393619432806,0.00160635848755784,0.00664782012914777,0.00880863816628990,0.0104353111527619,-0.000685625370395844,0.00796123970109250,0.00783594068313559,0.0101019478411656,-0.00203143220440026,0.00879741532100590,0.00684498665793959,0.0100291283917917,-0.00244800750512764,0.00898184688476786,0.00665926084656367],
      [0.0466547385211699,0.0194199975202388,0.0111024412113265,0.00270823830207435,0.00573784141382834,0.00891870713245928,0.0114960158893637,0.000670753007105084,0.00697931035517952,0.00799470742335227,0.0108890807145011,-0.00158336206495600,0.00827356617149219,0.00672243775550660,0.0107521233917508,-0.00111494614521109,0.00808722231775449,0.00678791561199155,0.0385246701380718,0.0178353232112250,0.00885665374391332,0.00159253095588729,0.00566618121619032,0.00768294907961429,0.00916028920872701,-0.000125546621274717,0.00666672057317616,0.00696819829615816,0.00880634630680805,-0.00188612606539418,0.00764518422706615,0.00588664680336678,0.00855570248489226,-0.00137621541080744,0.00738029722257934,0.00600162356252374],
      [0.361402807425791,0.116818888403877,0.0784727357215461,0.0218209857384425,0.0277035670479357,0.0513390247834878,0.0826839345938232,0.00668477789081098,0.0374890553530229,0.0451980881436472,0.0807409160936473,-0.00322053789458281,0.0442808219919840,0.0393580481743461,0.0796753413579246,-0.00236076754068524,0.0439747853659302,0.0385246701380718,0.721717408082087,0.151862279063305,0.111614059952742,0.0168917322852069,0.0476629924970995,0.0704405371812413,0.114883429245782,0.00663201807470117,0.0543970180956238,0.0662415648992401,0.120079404576165,-0.00743552233232893,0.0666115590041481,0.0580309733594194,0.118037797757388,-0.00757529922482773,0.0671916011521672,0.0561020712696929],
      [0.121942053882977,0.0578355736858628,0.0299067470512735,0.00901918420379835,0.0144632316836233,0.0231581775544190,0.0309078501014965,0.00428455468500049,0.0172066739522044,0.0212538615950055,0.0286736845060828,-0.00225474105520967,0.0206844395888960,0.0179712381378247,0.0283039579306614,-0.00201257407783952,0.0204844118531375,0.0178353232112250,0.151862279063305,0.0657872489468691,0.0317218604554322,0.00647721489825081,0.0182711661758239,0.0255029451620213,0.0325609776434869,0.00225871775160216,0.0207229757615036,0.0238393906387263,0.0327084419285240,-0.00456876531580658,0.0247833845835398,0.0205894845197792,0.0320257835120893,-0.00426152930415938,0.0245655723823830,0.0203708515039803],
      [0.0726252079406170,0.0266953307167881,0.0178323960594352,0.00454661540205569,0.00685774063010008,0.0117787214251595,0.0183954461094622,0.00176646069189922,0.00861171591368448,0.0105264255857548,0.0177297797486554,-0.000873089493719083,0.0102305417623996,0.00897428006738813,0.0175216359292110,-0.000654230538749693,0.0101393619432806,0.00885665374391332,0.111614059952742,0.0317218604554322,0.0238193028530741,0.00328594211477084,0.00998554935070048,0.0146005243057557,0.0232457376469426,0.00133585807234804,0.0110927827887620,0.0133079914296152,0.0229473244585718,-0.00148761351202461,0.0130725778692153,0.0113930870202507,0.0226267605949433,-0.00136198359133413,0.0130724948191238,0.0112067137490996],
      [0.0132432731828132,0.00463468005418670,0.00293092407757629,0.00294427980143546,0.000114948712441739,0.00250366724295251,0.00410334491950447,-0.000728463678442498,0.00192695552452475,0.00140628874289993,0.00350915290343489,2.97708504610328e-05,0.00168540960786820,0.00149380816403434,0.00353209814712372,0.000209676021122852,0.00160635848755784,0.00159253095588729,0.0168917322852069,0.00647721489825081,0.00328594211477084,0.00372985350986408,0.000251634739032213,0.00345058668124689,0.00498005885551725,-0.00111102012335569,0.00287453422215348,0.00206816754523043,0.00441288941607674,-0.000356967595159379,0.00254581590875507,0.00209946106135066,0.00448905116564676,-0.000117786397894654,0.00245193583469208,0.00224432253979054],
      [0.0375451441228438,0.0167055287705195,0.00919524357216057,0.00171684592633353,0.00516505204383088,0.00728940678790398,0.00897291777521326,0.00165450984895628,0.00536513555384836,0.00704298550389826,0.00847636965700833,-0.000819541465372112,0.00668414351500589,0.00579795727920235,0.00831390650575915,-0.000821656973696434,0.00664782012914777,0.00566618121619032,0.0476629924970995,0.0182711661758239,0.00998554935070048,0.000251634739032213,0.00685049679663673,0.00779729183507178,0.00924031021589400,0.00119882900440217,0.00626953482347682,0.00783939827014809,0.00933025096354576,-0.00137481259126677,0.00780756192094731,0.00653256870230440,0.00900821304830303,-0.00150403678691020,0.00785953893897070,0.00627915990172442],
      [0.0539623846549658,0.0221551353330602,0.0129361579634948,0.00439251710859732,0.00577748962857037,0.0103525973189758,0.0136767892745572,0.00109277373541330,0.00770905832875434,0.00899988422107916,0.0126755924068984,-0.000947665925679649,0.00893113633450487,0.00772700004072741,0.0125051355991965,-0.000767041708788050,0.00880863816628990,0.00768294907961429,0.0704405371812413,0.0255029451620213,0.0146005243057557,0.00345058668124689,0.00779729183507178,0.0119206830906579,0.0150817115079380,0.000295945991242233,0.00961524629254184,0.0105288860430279,0.0146266065369802,-0.00184805731534307,0.0109764375944441,0.00911088310211708,0.0143433139316232,-0.00169875892724787,0.0108997046141460,0.00902354794255782],
      [0.0759210538720586,0.0274048900105438,0.0184744657581586,0.00570037912630097,0.00658181794202052,0.0123892462748729,0.0198944754406513,0.00106690458705607,0.00919936066811382,0.0106845685577485,0.0188120359774508,-0.000846043501064046,0.0105302072365606,0.00925345736294322,0.0186436346757814,-0.000616266517198215,0.0104353111527619,0.00916028920872701,0.114883429245782,0.0325609776434869,0.0232457376469426,0.00498005885551725,0.00924031021589400,0.0150817115079380,0.0262284320801737,0.000107168838389045,0.0123554331040741,0.0137993385514440,0.0242371370609741,-0.00152796579032686,0.0135058809791705,0.0118015839425850,0.0239456516896467,-0.00155486165825646,0.0135995569198669,0.0115174031673626],
      [-0.00168176225260825,2.16834568771378e-05,-3.46100955952486e-05,-0.00112287698477667,0.000265334222171931,-0.000821793554494265,-0.000939453192095691,0.00196761671282399,-0.00129563586338004,0.000173410993647610,-0.000580076973101854,0.000700077013744395,-0.000697759068988541,-0.000121039217276250,-0.000580715998409644,0.000649811640376943,-0.000685625370395844,-0.000125546621274717,0.00663201807470117,0.00225871775160216,0.00133585807234804,-0.00111102012335569,0.00119882900440217,0.000295945991242233,0.000107168838389045,0.00268833361966350,-0.000818366730251421,0.00138795840308504,0.000871863629221587,0.000619150437675950,0.000296738020593016,0.000868231151842380,0.000788900445947103,0.000439981242805745,0.000392116629111371,0.000710381592545261],
      [0.0462705527006805,0.0192934014286293,0.0109478415060514,0.00386704520773219,0.00512112096351065,0.00919576819728390,0.0118595421358191,0.000251193564540092,0.00720238203844992,0.00778812084172223,0.0108174438360165,-0.00121192024490309,0.00807048221524429,0.00672502977608394,0.0106482688217853,-0.00106113962710213,0.00796123970109250,0.00666672057317616,0.0543970180956238,0.0207229757615036,0.0110927827887620,0.00287453422215348,0.00626953482347682,0.00961524629254184,0.0123554331040741,-0.000818366730251421,0.00850109204760875,0.00836067953895040,0.0114630539428966,-0.00192035716026012,0.00915451650825012,0.00727226391111912,0.0112239041449116,-0.00177662072742049,0.00906221036520884,0.00722775069430918],
      [0.0479657386899535,0.0203401107297310,0.0116929362269536,0.00312048941253975,0.00567950746078331,0.00900542429366981,0.0119193371526528,0.00193509781431234,0.00645971467081622,0.00845451266813383,0.0111471647302227,-0.000621396109567943,0.00790482147932248,0.00706393694365084,0.0109875746202778,-0.000555245793592938,0.00783594068313559,0.00696819829615816,0.0662415648992401,0.0238393906387263,0.0133079914296152,0.00206816754523043,0.00783939827014809,0.0105288860430279,0.0137993385514440,0.00138795840308504,0.00836067953895040,0.0103182641899880,0.0133488932069798,-0.00140426336858644,0.0100042665821499,0.00864165707930277,0.0130017437018199,-0.00152941256099815,0.0100724324414198,0.00835074475543813],
      [0.0747080297816002,0.0266613224318663,0.0176897384727812,0.00532344900162504,0.00630356989194549,0.0117315465873236,0.0187976863616255,0.00141610564321802,0.00859964466800269,0.0102138924023984,0.0186097373386172,-0.00101865919471896,0.0102656922343550,0.00887834250940078,0.0183016515248379,-0.000639446810823043,0.0101019478411656,0.00880634630680805,0.120079404576165,0.0327084419285240,0.0229473244585718,0.00441288941607674,0.00933025096354576,0.0146266065369802,0.0242371370609741,0.000871863629221587,0.0114630539428966,0.0133488932069798,0.0259288932810634,-0.00203179039489749,0.0140634057672288,0.0119267495869713,0.0246945718491921,-0.00158214031903262,0.0136956890221972,0.0115698672945054],
      [-0.0120864546929862,-0.00528119241684200,-0.00254132333324172,-0.000905374766552308,-0.00136638764138184,-0.00240918493186005,-0.00277191272603916,0.000106607474431605,-0.00197099318043390,-0.00198137317297390,-0.00294714693353854,0.00131307285826154,-0.00259078051898609,-0.00155874554632382,-0.00255324724006753,6.08420416248514e-05,-0.00203143220440026,-0.00188612606539418,-0.00743552233232893,-0.00456876531580658,-0.00148761351202461,-0.000356967595159379,-0.00137481259126677,-0.00184805731534307,-0.00152796579032686,0.000619150437675950,-0.00192035716026012,-0.00140426336858644,-0.00203179039489749,0.00201860772056423,-0.00264149130445210,-0.00101436504331749,-0.00152136290999889,4.85159406832371e-05,-0.00171742505400790,-0.00159797424247981],
      [0.0532241023116455,0.0222149975886107,0.0124431067552065,0.00385460560865898,0.00597243460649076,0.0101023822331403,0.0130275851357665,0.00119885668109772,0.00759611484870242,0.00896114012294850,0.0124355438578247,-0.00147963097452240,0.00914561510206579,0.00757597694983924,0.0120768558584028,-0.000835778348634403,0.00879741532100590,0.00764518422706615,0.0666115590041481,0.0247833845835398,0.0130725778692153,0.00254581590875507,0.00780756192094731,0.0109764375944441,0.0135058809791705,0.000296738020593016,0.00915451650825012,0.0100042665821499,0.0140634057672288,-0.00264149130445210,0.0111141256116177,0.00861212813494973,0.0132982131510170,-0.00172132789983853,0.0105513715546644,0.00867450591154445],
      [0.0408897173770164,0.0174623752191667,0.00991448072240937,0.00294724485762602,0.00472554993839658,0.00778392150915872,0.0102382760216327,0.00133810474703704,0.00569433226857054,0.00710054658643097,0.00954939593194851,-0.000414373900657289,0.00672991917723944,0.00608804849915296,0.00950167279225343,-0.000727757040717858,0.00684498665793959,0.00588664680336678,0.0580309733594194,0.0205894845197792,0.0113930870202507,0.00209946106135066,0.00653256870230440,0.00911088310211708,0.0118015839425850,0.000868231151842380,0.00727226391111912,0.00864165707930277,0.0119267495869713,-0.00101436504331749,0.00861212813494973,0.00759454528185851,0.0115489686733359,-0.00162124770146477,0.00885193137024264,0.00711299227402525],
      [0.0729369866361307,0.0260834771051091,0.0173012652575821,0.00525297208055378,0.00614020954719486,0.0114576845110280,0.0184394011568433,0.00132165094762931,0.00842816681645829,0.00995060868195415,0.0181084795248346,-0.000774153146598780,0.00992371571543941,0.00870676284431552,0.0181475427354119,-0.000922771592208468,0.0100291283917917,0.00855570248489226,0.118037797757388,0.0320257835120893,0.0226267605949433,0.00448905116564676,0.00900821304830303,0.0143433139316232,0.0239456516896467,0.000788900445947103,0.0112239041449116,0.0130017437018199,0.0246945718491921,-0.00152136290999889,0.0132982131510170,0.0115489686733359,0.0254176306971378,-0.00193255475560439,0.0138085613708797,0.0114515063325644],
      [-0.00907715813403609,-0.00471014929117413,-0.00223540348847444,-0.000842227933470435,-0.00131386354642790,-0.00223556480132108,-0.00238550367381652,6.59972429751803e-05,-0.00183641710204705,-0.00183897000205496,-0.00212687695462374,-7.79017159304869e-05,-0.00181552583084278,-0.00180003620557692,-0.00249259712743066,0.00130855868507192,-0.00244800750512764,-0.00137621541080744,-0.00757529922482773,-0.00426152930415938,-0.00136198359133413,-0.000117786397894654,-0.00150403678691020,-0.00169875892724787,-0.00155486165825646,0.000439981242805745,-0.00177662072742049,-0.00152941256099815,-0.00158214031903262,4.85159406832371e-05,-0.00172132789983853,-0.00162124770146477,-0.00193255475560439,0.00202504440936292,-0.00262275278528237,-0.000972924361730893],
      [0.0517239848799406,0.0218717922886512,0.0122693078508606,0.00382105455678612,0.00591832758372649,0.00998084022478105,0.0128113385889265,0.00120950044432789,0.00749299199434515,0.00885627059513172,0.0120262085667978,-0.000845108929299782,0.00873102716011375,0.00766324161055894,0.0120745504433146,-0.00141367287071130,0.00898184688476786,0.00738029722257934,0.0671916011521672,0.0245655723823830,0.0130724948191238,0.00245193583469208,0.00785953893897070,0.0108997046141460,0.0135995569198669,0.000392116629111371,0.00906221036520884,0.0100724324414198,0.0136956890221972,-0.00171742505400790,0.0105513715546644,0.00885193137024264,0.0138085613708797,-0.00262275278528237,0.0110887366038272,0.00842326406710555],
      [0.0414807161067009,0.0174595448529864,0.00988251226136343,0.00294888979222836,0.00469132332684277,0.00776656761619933,0.0102700022745652,0.00126775103607386,0.00571783358044195,0.00706046268236221,0.00966914016962025,-0.000874530489202974,0.00694292265208757,0.00591171011955172,0.00943777158141186,-0.000365118061270627,0.00665926084656367,0.00600162356252374,0.0561020712696929,0.0203708515039803,0.0112067137490996,0.00224432253979054,0.00627915990172442,0.00902354794255782,0.0115174031673626,0.000710381592545261,0.00722775069430918,0.00835074475543813,0.0115698672945054,-0.00159797424247981,0.00867450591154445,0.00711299227402525,0.0114515063325644,-0.000972924361730893,0.00842326406710555,0.00729567185187582]])

    self.model_param_mu = np.array([2.31673917782623,0.755557250821190,0.742872781065091,0.0745819661150443,0.0950949182754435,0.146552739195368,0.750931329803799,0.0488075516394418,0.108226207978239,0.137946751922701,0.769389286826535,-0.0181969623079750,0.134327607911685,0.119361212922745,0.768624727499221,-0.0199103410428962,0.134278329339847,0.118527611370485,2.57327670507630,0.786788836956861,0.777243693553409,0.0741693278120389,0.106186335460515,0.158848853855242,0.789430395515414,0.0427828221071781,0.122068066576331,0.150328766084662,0.799823419495483,-0.0190986573634235,0.148008561195825,0.131788802367034,0.798945188414827,-0.0202006460644533,0.147794806982955,0.131151902191033])



